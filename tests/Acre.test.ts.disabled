import {
  openTransportReplayer,
  RecordStore,
} from "@ledgerhq/hw-transport-mocker";
import Acre from "../src/Acre";

test("btc 3", async () => {
  const transport = await openTransportReplayer(
    RecordStore.fromString(`
    => e042000009000000010100000001
    <= 9000
    => e0428000254ea60aeac5252c14291d428915bd7ccd1bfc4af009f4d4dc57ae597ed0420b71010000008a
    <= 9000
    => e04280003247304402201f36a12c240dbf9e566bc04321050b1984cd6eaf6caee8f02bb0bfec08e3354b022012ee2aeadcbbfd1e92959f
    <= 9000
    => e04280003257c15c1c6debb757b798451b104665aa3010569b49014104090b15bde569386734abf2a2b99f9ca6a50656627e77de663ca7
    <= 9000
    => e04280002a325702769986cf26cc9dd7fdea0af432c8e2becc867c932e1b9dd742f2a108997c2252e2bdebffffffff
    <= 9000
    => e04280000102
    <= 9000
    => e04280002281b72e00000000001976a91472a5d75c8d2d0565b656a5232703b167d50d5a2b88ac
    <= 9000
    => e042800022a0860100000000001976a9144533f5fb9b4817f713c48f0bfe96b9f50c476c9b88ac
    <= 9000
    => e04280000400000000
    <= 3200e4eac773da236484dae8f0fdba3d7e0ba1d05070d1a34fc44943e638441262a04f1001000000a086010000000000c79483cc9a6e96fe9000
    => e0440000050100000001
    <= 9000
    => e04480002600c773da236484dae8f0fdba3d7e0ba1d05070d1a34fc44943e638441262a04f100100000069
    <= 9000
    => e04480003252210289b4a3ad52a919abd2bdd6920d8a6879b1e788c38aa76f0440a6f32a9f1996d02103a3393b1439d1693b063482c04b
    <= 9000
    => e044800032d40142db97bdf139eedd1b51ffb7070a37eac321030b9a409a1e476b0d5d17b804fcdb81cf30f9b99c6f3ae1178206e08bc5
    <= 9000
    => e04480000900639853aeffffffff
    <= 9000
    => e04a80002301905f0100000000001976a91472a5d75c8d2d0565b656a5232703b167d50d5a2b88ac
    <= 00009000
    => e04800001303800000000000000000000000000000000001
    <= 3045022100b5b1813992282b9a1fdd957b9751d79dc21018abc6586336e272212cc89cfe84022053765a1da0bdb5a0631a9866f1fd4c583589d5188b11cfa302fc20cd2611a71e019000
    `)
  );
  const acre = new Acre({ transport });
  const tx1 = acre.splitTransaction(
    "01000000014ea60aeac5252c14291d428915bd7ccd1bfc4af009f4d4dc57ae597ed0420b71010000008a47304402201f36a12c240dbf9e566bc04321050b1984cd6eaf6caee8f02bb0bfec08e3354b022012ee2aeadcbbfd1e92959f57c15c1c6debb757b798451b104665aa3010569b49014104090b15bde569386734abf2a2b99f9ca6a50656627e77de663ca7325702769986cf26cc9dd7fdea0af432c8e2becc867c932e1b9dd742f2a108997c2252e2bdebffffffff0281b72e00000000001976a91472a5d75c8d2d0565b656a5232703b167d50d5a2b88aca0860100000000001976a9144533f5fb9b4817f713c48f0bfe96b9f50c476c9b88ac00000000"
  );
  const result = await acre.signP2SHTransaction({
    inputs: [
      [
        tx1,
        1,
        "52210289b4a3ad52a919abd2bdd6920d8a6879b1e788c38aa76f0440a6f32a9f1996d02103a3393b1439d1693b063482c04bd40142db97bdf139eedd1b51ffb7070a37eac321030b9a409a1e476b0d5d17b804fcdb81cf30f9b99c6f3ae1178206e08bc500639853ae",
        undefined,
      ],
    ],
    associatedKeysets: ["0'/0/0"],
    outputScriptHex:
      "01905f0100000000001976a91472a5d75c8d2d0565b656a5232703b167d50d5a2b88ac",
  });
  expect(result).toEqual([
    "3045022100b5b1813992282b9a1fdd957b9751d79dc21018abc6586336e272212cc89cfe84022053765a1da0bdb5a0631a9866f1fd4c583589d5188b11cfa302fc20cd2611a71e",
  ]);
});

test("btc 4", async () => {
  const transport = await openTransportReplayer(
    RecordStore.fromString(`
    => e04e000117048000002c800000008000000000000000000474657374
    <= 00009000
    => e04e80000100
    <= 3045022100e32b32b8a6b4228155ba4d1a536d8fed9900606663fbbf4ea420ed8e944f9c18022053c97c74d2f6d8620d060584dc7886f5f3003684bb249508eb7066215172281a9000
    `)
  );
  const acre = new Acre({ transport });
  const result = await acre.signMessage(
    "44'/0'/0'/0",
    Buffer.from("test").toString("hex")
  );
  expect(result).toEqual({
    r: "e32b32b8a6b4228155ba4d1a536d8fed9900606663fbbf4ea420ed8e944f9c18",
    s: "53c97c74d2f6d8620d060584dc7886f5f3003684bb249508eb7066215172281a",
    v: 0,
  });
});

test("acre sign p2sh seg", async () => {
  const transport = await openTransportReplayer(
    RecordStore.fromString(`
    => e0440002050100000001
    <= 9000
    => e04480022e021ba3852a59cded8d2760434fa75af58a617b21e4fbe1cf9c826ea2f14f80927d00000000102700000000000000
    <= 9000
    => e044800204ffffffff
    <= 9000
    => e04a8000230188130000000000001976a9140ae1441568d0d293764a347b191025c51556cecd88ac
    <= 00009000
    => e0440080050100000001
    <= 9000
    => e04480802e021ba3852a59cded8d2760434fa75af58a617b21e4fbe1cf9c826ea2f14f80927d00000000102700000000000047
    <= 9000
    => e0448080325121026666422d00f1b308fc7527198749f06fedb028b979c09f60d0348ef79c985e41210384257cf895f1ca492bbee5d748
    <= 9000
    => e0448080195ae0ef479036fdf59e15b92e37970a98d6fe7552aeffffffff
    <= 9000
    => e04800001303800000000000000000000000000000000001
    <= 3045022100932934ee326c19c81b72fb03cec0fb79ff980a8076639f77c7edec35bd59da1e02205e4030e8e0fd2405f6db2fe044c49d3f191adbdc0e05ec7ed4dcc4c6fe7310e5019000
    `)
  );
  const acre = new Acre({ transport });
  const tx1 = acre.splitTransaction(
    "0100000001d3a05cd6e15582f40e68bb8b1559dc9e5b3e4f9f34d92c1217dc8c3355bc844e010000008a47304402207ab1a4768cbb036d4bce3c4a294c13cc5ae6076fc7bedce88c62aa80ae366da702204f8fea6923f8df36315c0c26cb42d8d7ab52ca4736776816e10d6ce51906d0600141044289801366bcee6172b771cf5a7f13aaecd237a0b9a1ff9d769cabc2e6b70a34cec320a0565fb7caf11b1ca2f445f9b7b012dda5718b3cface369ee3a034ded6ffffffff02102700000000000017a9141188cc3c265fbc01a025fc8adec9823effd0cef187185f9265170100001976a9140ae1441568d0d293764a347b191025c51556cecd88ac00000000",
    true
  );
  const result = await acre.signP2SHTransaction({
    inputs: [
      [
        tx1,
        0,
        "5121026666422d00f1b308fc7527198749f06fedb028b979c09f60d0348ef79c985e41210384257cf895f1ca492bbee5d7485ae0ef479036fdf59e15b92e37970a98d6fe7552ae",
        undefined,
      ],
    ],
    associatedKeysets: ["0'/0/0"],
    outputScriptHex:
      "0188130000000000001976a9140ae1441568d0d293764a347b191025c51556cecd88ac",
    segwit: true,
  });
  expect(result).toEqual([
    "3045022100932934ee326c19c81b72fb03cec0fb79ff980a8076639f77c7edec35bd59da1e02205e4030e8e0fd2405f6db2fe044c49d3f191adbdc0e05ec7ed4dcc4c6fe7310e501",
  ]);
});

test("signMessage", async () => {
  const transport = await openTransportReplayer(
    RecordStore.fromString(`
    => e04e00011d058000002c800000008000000000000000000000000006666f6f626172
    <= 00009000
    => e04e80000100
    <= 314402205eac720be544d3959a760d9bfd6a0e7c86d128fd1030038f06d85822608804e20220385d83273c9d03c469596292fb354b07d193034f83c2633a4c1f057838e12a5b9000
    `)
  );
  const acre = new Acre({ transport });
  const res = await acre.signMessage(
    "44'/0'/0'/0/0",
    Buffer.from("foobar").toString("hex")
  );
  expect(res).toEqual({
    v: 1,
    r: "5eac720be544d3959a760d9bfd6a0e7c86d128fd1030038f06d85822608804e2",
    s: "385d83273c9d03c469596292fb354b07d193034f83c2633a4c1f057838e12a5b",
  });
});
